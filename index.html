<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,300;0,400;1,300&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #0a0a0a;
      --ink-mid: #3a3a3a;
      --ink-light: #888;
      --ink-faint: #ccc;
      --paper: #f5f2ec;
      --paper-dark: #e8e4db;
      --rule: #d0ccc3;
    }

    html, body {
      width: 100%;
      min-height: 100vh;
      background: var(--paper);
      color: var(--ink);
      font-family: 'Spectral', Georgia, serif;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      padding: 28px 24px 40px;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 18px;
      border-bottom: 1.5px solid var(--ink);
    }

    .time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 3rem;
      font-weight: 300;
      letter-spacing: -1px;
      line-height: 1;
    }

    .date-line {
      font-size: 0.82rem;
      color: var(--ink-mid);
      font-style: italic;
      margin-top: 4px;
    }

    .header-right {
      text-align: right;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--ink-light);
      padding-top: 4px;
    }

    .refresh-btn {
      background: none;
      border: 1px solid var(--rule);
      color: var(--ink-mid);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      padding: 3px 8px;
      cursor: pointer;
      margin-top: 6px;
      border-radius: 2px;
      display: block;
      margin-left: auto;
    }
    .refresh-btn:hover { background: var(--paper-dark); }

    /* â”€â”€ SECTIONS â”€â”€ */
    section {
      padding: 18px 0;
      border-bottom: 1px solid var(--rule);
    }
    section:last-of-type { border-bottom: none; }

    .section-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--ink-light);
      margin-bottom: 12px;
    }

    /* â”€â”€ WEATHER â”€â”€ */
    .weather-main {
      display: flex;
      align-items: flex-end;
      gap: 14px;
      margin-bottom: 10px;
    }
    .weather-temp {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2.6rem;
      font-weight: 300;
      line-height: 1;
    }
    .weather-desc { font-size: 1rem; font-style: italic; color: var(--ink-mid); padding-bottom: 4px; }
    .weather-details {
      display: flex; gap: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem; color: var(--ink-mid); flex-wrap: wrap;
    }
    .weather-forecast { display: flex; margin-top: 12px; }
    .forecast-day {
      flex: 1; text-align: center; padding: 7px 4px;
      border-left: 1px solid var(--rule);
      font-family: 'JetBrains Mono', monospace;
    }
    .forecast-day:first-child { border-left: none; }
    .forecast-name { font-size: 0.58rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-light); }
    .forecast-icon { font-size: 1.1rem; margin: 4px 0; }
    .forecast-temps { font-size: 0.68rem; color: var(--ink-mid); }
    .forecast-high { color: var(--ink); }

    /* â”€â”€ NETATMO â”€â”€ */
    .netatmo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }
    .netatmo-module {
      padding: 10px 6px 10px 0;
      border-bottom: 1px solid var(--paper-dark);
    }
    .netatmo-module:nth-last-child(-n+2) { border-bottom: none; }
    .netatmo-module-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.58rem; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--ink-light);
      margin-bottom: 5px;
    }
    .netatmo-big {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.5rem; font-weight: 300; line-height: 1; margin-bottom: 3px;
    }
    .netatmo-rows { display: flex; flex-direction: column; gap: 2px; }
    .netatmo-row { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; }
    .netatmo-key { font-family: 'JetBrains Mono', monospace; font-size: 0.62rem; color: var(--ink-light); }
    .netatmo-val { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; color: var(--ink); }
    .netatmo-notice { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--ink-light); font-style: italic; }

    /* â”€â”€ GROWATT â”€â”€ */
    .growatt-main { display: flex; align-items: flex-end; gap: 16px; margin-bottom: 12px; }
    .growatt-power { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 300; line-height: 1; }
    .growatt-power-label { font-size: 0.82rem; font-style: italic; color: var(--ink-mid); padding-bottom: 4px; }
    .growatt-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 1px; background: var(--rule); border: 1px solid var(--rule);
    }
    .growatt-cell { background: var(--paper); padding: 8px 10px; }
    .growatt-cell-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.58rem; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--ink-light); margin-bottom: 3px;
    }
    .growatt-cell-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--ink); }
    .growatt-cell-sub { font-family: 'JetBrains Mono', monospace; font-size: 0.62rem; color: var(--ink-light); margin-top: 2px; }
    .battery-bar-wrap { height: 5px; background: var(--paper-dark); border-radius: 1px; margin-top: 5px; overflow: hidden; }
    .battery-bar-fill { height: 100%; background: var(--ink-mid); border-radius: 1px; }
    .direction-badge {
      display: inline-block; font-family: 'JetBrains Mono', monospace;
      font-size: 0.58rem; padding: 1px 5px; border: 1px solid var(--rule);
      border-radius: 2px; color: var(--ink-mid); margin-left: 4px;
    }
    .growatt-updated { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); margin-top: 8px; }
    .growatt-notice { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--ink-light); font-style: italic; }

    /* â”€â”€ CALENDAR â”€â”€ */
    .event-list { display: flex; flex-direction: column; gap: 5px; }
    .event-item { display: flex; gap: 10px; align-items: baseline; }
    .event-time { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--ink-light); min-width: 72px; flex-shrink: 0; }
    .event-dot { width: 4px; height: 4px; background: var(--ink); border-radius: 50%; flex-shrink: 0; margin-top: 7px; }
    .event-title { font-size: 0.92rem; line-height: 1.35; }
    .cal-meta { font-size: 0.85rem; font-style: italic; color: var(--ink-mid); margin-bottom: 10px; }
    .ics-notice { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--ink-light); font-style: italic; margin-top: 6px; }

    /* â”€â”€ TASKS â”€â”€ */
    .task-list { display: flex; flex-direction: column; gap: 1px; }
    .task-item { display: flex; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid var(--paper-dark); }
    .task-item:last-child { border-bottom: none; }
    .task-check { width: 14px; height: 14px; border: 1.5px solid var(--ink-mid); border-radius: 1px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .task-item.done .task-check::after { content: 'Ã—'; font-size: 12px; color: var(--ink-mid); }
    .task-text { font-size: 0.9rem; line-height: 1.4; }
    .task-item.done .task-text { color: var(--ink-light); text-decoration: line-through; }
    .task-manage-link { display: inline-block; margin-top: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; color: var(--ink-light); text-decoration: none; border-bottom: 1px solid var(--rule); }
    .task-manage-link:hover { color: var(--ink-mid); }
    .empty-note { font-style: italic; font-size: 0.85rem; color: var(--ink-light); }

    /* â”€â”€ FOOTER â”€â”€ */
    .footer { padding-top: 14px; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--ink-faint); display: flex; justify-content: space-between; }
  </style>
</head>
<body>

  <header class="header">
    <div>
      <div class="time" id="clock">--:--</div>
      <div class="date-line" id="date-line">naÄÃ­tÃ¡mâ€¦</div>
    </div>
    <div class="header-right">
      <div id="last-update">â€“</div>
      <button class="refresh-btn" onclick="initAll()">â†º obnovit</button>
    </div>
  </header>

  <section>
    <div class="section-label">PoÄasÃ­ Â· Vranov u Brna</div>
    <div class="weather-main">
      <div class="weather-temp" id="w-temp">â€“</div>
      <div class="weather-desc" id="w-desc">naÄÃ­tÃ¡mâ€¦</div>
    </div>
    <div class="weather-details">
      <span id="w-wind">ğŸ’¨ â€“</span>
      <span id="w-humid">ğŸ’§ â€“</span>
      <span id="w-rain">ğŸŒ§ â€“</span>
    </div>
    <div class="weather-forecast" id="w-forecast"></div>
  </section>

  <section>
    <div class="section-label">Netatmo stanice</div>
    <div id="netatmo-content"><div class="netatmo-notice">naÄÃ­tÃ¡mâ€¦</div></div>
  </section>

  <section>
    <div class="section-label">SolÃ¡rnÃ­ systÃ©m Â· Growatt</div>
    <div id="growatt-content"><div class="growatt-notice">naÄÃ­tÃ¡mâ€¦</div></div>
  </section>

  <section>
    <div class="section-label">KalendÃ¡Å™</div>
    <div class="cal-meta" id="cal-meta"></div>
    <div class="event-list" id="event-list"></div>
    <div class="ics-notice" id="ics-notice"></div>
  </section>

  <section>
    <div class="section-label">Ãškoly</div>
    <div class="task-list" id="task-list"><div class="empty-note">Å¾Ã¡dnÃ© Ãºkoly</div></div>
    <a href="tasks.html" class="task-manage-link">â†’ spravovat Ãºkoly</a>
  </section>

  <footer class="footer">
    <span>Vranov u Brna</span>
    <span id="footer-date">â€“</span>
  </footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONFIGURACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// --- Netatmo ---
// 1. Jdi na https://dev.netatmo.com â†’ "Create an app"
// 2. ZkopÃ­ruj client_id a client_secret
// 3. V nastavenÃ­ aplikace pÅ™idej Redirect URI: URL tÃ©to strÃ¡nky (napÅ™. https://uzivatel.github.io/home_dashboard/)
// 4. Klikni "PÅ™ipojit Netatmo" v dashboardu â€“ pÅ™ihlÃ¡sÃ­Å¡ se jednorÃ¡zovÄ› pÅ™es Netatmo web
const NETATMO_CLIENT_ID     = '6999df538c183536540712b8';
const NETATMO_CLIENT_SECRET = '80FEIu8kBhqVopb2TCALKHFtj65132qzo9h7r';
// Alternativa: vloÅ¾ pÅ™Ã­mo access_token (platnÃ½ ~3 hodiny, pak je tÅ™eba obnovit)
const NETATMO_ACCESS_TOKEN  = '';

// --- Growatt ---
// Soubor generovanÃ½ GitHub Actions skriptem kaÅ¾dÃ½ch 15 minut
const GROWATT_JSON_URL = './data/growatt.json';

// --- Google KalendÃ¡Å™ ---
// Nastav â†’ NastavenÃ­ kalendÃ¡Å™e â†’ "TajnÃ¡ adresa ve formÃ¡tu iCal"
// KvÅ¯li CORS zabal pÅ™es proxy: 'https://corsproxy.io/?' + encodeURIComponent('https://calendar.google.com/...')
const ICS_URL = '';

// --- Poloha pro Open-Meteo ---
const LAT = 49.043, LON = 16.558;   // Vranov u Brna

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HODINY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const days   = ['nedÄ›le','pondÄ›lÃ­','ÃºterÃ½','stÅ™eda','Ätvrtek','pÃ¡tek','sobota'];
  const months = ['ledna','Ãºnora','bÅ™ezna','dubna','kvÄ›tna','Äervna','Äervence','srpna','zÃ¡Å™Ã­','Å™Ã­jna','listopadu','prosince'];
  document.getElementById('date-line').textContent =
    `${days[now.getDay()]}, ${now.getDate()}. ${months[now.getMonth()]} ${now.getFullYear()}`;
  document.getElementById('footer-date').textContent =
    `${now.getDate()}.${now.getMonth()+1}.${now.getFullYear()}`;
}
setInterval(updateClock, 1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN-METEO POÄŒASÃ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WMO = {0:'jasno',1:'skoro jasno',2:'polojasno',3:'zataÅ¾eno',45:'mlha',48:'jinovatka',51:'slabÃ© mrholenÃ­',53:'mrholenÃ­',55:'silnÃ© mrholenÃ­',61:'slabÃ½ dÃ©Å¡Å¥',63:'dÃ©Å¡Å¥',65:'silnÃ½ dÃ©Å¡Å¥',71:'slabÃ½ snÃ­h',73:'snÃ­h',75:'silnÃ½ snÃ­h',80:'pÅ™ehÃ¡Åˆky',81:'silnÃ© pÅ™ehÃ¡Åˆky',82:'pÅ™Ã­valovÃ½ dÃ©Å¡Å¥',85:'snÄ›hovÃ© pÅ™ehÃ¡Åˆky',95:'bouÅ™ka',96:'bouÅ™ka s krupobitÃ­m'};
const WMO_ICON={0:'â˜€ï¸',1:'ğŸŒ¤',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«',48:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',55:'ğŸŒ§',61:'ğŸŒ§',63:'ğŸŒ§',65:'ğŸŒ§',71:'ğŸŒ¨',73:'â„ï¸',75:'â„ï¸',80:'ğŸŒ¦',81:'ğŸŒ§',82:'ğŸŒ§',85:'ğŸŒ¨',95:'â›ˆ',96:'â›ˆ'};

async function fetchWeather() {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}`
      +`&current=temperature_2m,weathercode,windspeed_10m,relativehumidity_2m,precipitation`
      +`&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FPrague&forecast_days=5`;
    const {current:c, daily:d} = await (await fetch(url)).json();
    document.getElementById('w-temp').textContent = `${Math.round(c.temperature_2m)}Â°C`;
    document.getElementById('w-desc').textContent = WMO[c.weathercode]||'â€“';
    document.getElementById('w-wind').textContent = `ğŸ’¨ ${Math.round(c.windspeed_10m)} km/h`;
    document.getElementById('w-humid').textContent = `ğŸ’§ ${c.relativehumidity_2m}%`;
    document.getElementById('w-rain').textContent = `ğŸŒ§ ${c.precipitation} mm`;
    const dayN=['Ne','Po','Ãšt','St','ÄŒt','PÃ¡','So'];
    document.getElementById('w-forecast').innerHTML = d.time.slice(0,5).map((t,i)=>{
      const dn=new Date(t), name=i===0?'Dnes':i===1?'ZÃ­tra':dayN[dn.getDay()];
      return `<div class="forecast-day"><div class="forecast-name">${name}</div><div class="forecast-icon">${WMO_ICON[d.weathercode[i]]||'â€“'}</div><div class="forecast-temps"><span class="forecast-high">${Math.round(d.temperature_2m_max[i])}Â°</span><span style="color:var(--ink-light)"> / ${Math.round(d.temperature_2m_min[i])}Â°</span></div></div>`;
    }).join('');
  } catch(e) { document.getElementById('w-desc').textContent='chyba naÄÃ­tÃ¡nÃ­'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETATMO  (OAuth2 Authorization Code flow)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Zpracuje callback od Netatmo po pÅ™ihlÃ¡Å¡enÃ­ (code v URL)
async function handleNetatmoCallback() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('state') !== 'netatmo' || !params.get('code')) return;
  const code = params.get('code');
  history.replaceState({}, '', window.location.pathname);
  const el = document.getElementById('netatmo-content');
  el.innerHTML = '<div class="netatmo-notice">PÅ™ihlaÅ¡uji k Netatmoâ€¦</div>';
  try {
    const body = new URLSearchParams({
      grant_type: 'authorization_code', client_id: NETATMO_CLIENT_ID,
      client_secret: NETATMO_CLIENT_SECRET, code,
      redirect_uri: location.origin + location.pathname
    });
    const data = await (await fetch('https://api.netatmo.com/oauth2/token', {
      method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body
    })).json();
    if (data.access_token) {
      localStorage.setItem('netatmo_access_token', data.access_token);
      localStorage.setItem('netatmo_refresh_token', data.refresh_token);
      localStorage.setItem('netatmo_expires_at', Date.now() + data.expires_in * 1000);
    }
  } catch(e) {}
}

async function refreshNetatmoToken(refreshToken) {
  try {
    const body = new URLSearchParams({
      grant_type: 'refresh_token', client_id: NETATMO_CLIENT_ID,
      client_secret: NETATMO_CLIENT_SECRET, refresh_token: refreshToken
    });
    const data = await (await fetch('https://api.netatmo.com/oauth2/token', {
      method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body
    })).json();
    if (data.access_token) {
      localStorage.setItem('netatmo_access_token', data.access_token);
      localStorage.setItem('netatmo_refresh_token', data.refresh_token);
      localStorage.setItem('netatmo_expires_at', Date.now() + data.expires_in * 1000);
      return data.access_token;
    }
  } catch(e) {}
  localStorage.removeItem('netatmo_access_token');
  localStorage.removeItem('netatmo_refresh_token');
  localStorage.removeItem('netatmo_expires_at');
  return null;
}

async function getNetatmoToken() {
  if (NETATMO_ACCESS_TOKEN) return NETATMO_ACCESS_TOKEN;
  const expiresAt = parseInt(localStorage.getItem('netatmo_expires_at') || '0');
  const accessToken = localStorage.getItem('netatmo_access_token');
  if (accessToken && Date.now() < expiresAt - 60000) return accessToken;
  const refreshToken = localStorage.getItem('netatmo_refresh_token');
  if (refreshToken && NETATMO_CLIENT_ID) return await refreshNetatmoToken(refreshToken);
  return null;
}

function authorizeNetatmo() {
  const params = new URLSearchParams({
    client_id: NETATMO_CLIENT_ID,
    redirect_uri: location.origin + location.pathname,
    scope: 'read_station', state: 'netatmo'
  });
  window.location.href = `https://api.netatmo.com/oauth2/authorize?${params}`;
}

function disconnectNetatmo() {
  localStorage.removeItem('netatmo_access_token');
  localStorage.removeItem('netatmo_refresh_token');
  localStorage.removeItem('netatmo_expires_at');
  fetchNetatmo();
}

const NLABELS = {Temperature:'Teplota',Humidity:'Vlhkost',CO2:'COâ‚‚',Noise:'Hluk',Pressure:'Tlak',AbsolutePressure:'Abs. tlak',Rain:'DÃ©Å¡Å¥',sum_rain_1:'DÃ©Å¡Å¥/h',sum_rain_24:'DÃ©Å¡Å¥/24h',WindStrength:'VÃ­tr',WindAngle:'SmÄ›r',GustStrength:'NÃ¡razy',GustAngle:'Sm. nÃ¡razu'};

function fmtN(k,v) {
  const n = Number(v);
  const f1 = isNaN(n) ? v : n.toFixed(1);
  const r  = isNaN(n) ? v : Math.round(n);
  const map = {
    Temperature:`${f1} Â°C`, Humidity:`${r} %`, CO2:`${r} ppm`, Noise:`${r} dB`,
    Pressure:`${f1} hPa`, AbsolutePressure:`${f1} hPa`,
    Rain:`${f1} mm`, sum_rain_1:`${f1} mm/h`, sum_rain_24:`${f1} mm/24h`,
    WindStrength:`${r} km/h`, WindAngle:`${r}Â°`, GustStrength:`${r} km/h`, GustAngle:`${r}Â°`
  };
  return map[k] ?? String(v);
}

async function fetchNetatmo() {
  const el = document.getElementById('netatmo-content');
  const token = await getNetatmoToken();
  if (!token) {
    el.innerHTML = NETATMO_CLIENT_ID
      ? `<div class="netatmo-notice">Netatmo nenÃ­ pÅ™ipojeno. <button onclick="authorizeNetatmo()" style="font-family:inherit;font-size:0.65rem;padding:2px 8px;border:1px solid var(--rule);background:none;cursor:pointer;margin-left:4px;">PÅ™ipojit Netatmo â†’</button></div>`
      : `<div class="netatmo-notice">Nastav NETATMO_CLIENT_ID a NETATMO_CLIENT_SECRET v kÃ³du.</div>`;
    return;
  }
  try {
    const data = await (await fetch('https://api.netatmo.com/api/getstationsdata', {
      headers: { Authorization: `Bearer ${token}` }
    })).json();
    const devices = data?.body?.devices;
    if (!devices?.length) { el.innerHTML='<div class="netatmo-notice">Å½Ã¡dnÃ¡ Netatmo zaÅ™Ã­zenÃ­.</div>'; return; }

    let html='<div style="text-align:right;margin-bottom:6px"><button onclick="disconnectNetatmo()" style="font-family:var(--font-mono,\'JetBrains Mono\',monospace);font-size:0.58rem;padding:1px 6px;border:1px solid var(--rule);background:none;color:var(--ink-light);cursor:pointer">odpojit</button></div><div class="netatmo-grid">';
    for (const station of devices) {
      const mods = [
        {name: station.module_name||'VnitÅ™nÃ­', dd: station.dashboard_data},
        ...(station.modules||[]).map(m=>({name:m.module_name||m.type, dd:m.dashboard_data}))
      ];
      for (const mod of mods) {
        if (!mod.dd) continue;
        const skip = new Set(['time_utc','date_max_temp','date_min_temp','min_temp','max_temp','Temperature']);
        html += `<div class="netatmo-module">
          <div class="netatmo-module-name">${mod.name}</div>`;
        if (mod.dd.Temperature !== undefined)
          html += `<div class="netatmo-big">${Number(mod.dd.Temperature).toFixed(1)}Â°C</div>`;
        html += '<div class="netatmo-rows">';
        for (const [k,v] of Object.entries(mod.dd)) {
          if (skip.has(k) || v===null || v===undefined) continue;
          html += `<div class="netatmo-row"><span class="netatmo-key">${NLABELS[k]||k}</span><span class="netatmo-val">${fmtN(k,v)}</span></div>`;
        }
        html += '</div></div>';
      }
    }
    html += '</div>';
    el.innerHTML = html;
  } catch(e) { el.innerHTML=`<div class="netatmo-notice">Chyba Netatmo: ${e.message}</div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GROWATT  (Äte data/growatt.json z GitHub Pages)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGrowatt() {
  const el = document.getElementById('growatt-content');
  try {
    const res = await fetch(`${GROWATT_JSON_URL}?t=${Date.now()}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (data.error) { el.innerHTML=`<div class="growatt-notice">Chyba: ${data.error}</div>`; return; }
    if (!data.plants?.length) { el.innerHTML='<div class="growatt-notice">Å½Ã¡dnÃ¡ zaÅ™Ã­zenÃ­.</div>'; return; }

    const plant = data.plants[0];
    const dev   = plant.devices?.[0];
    const sf    = (v,d=0)=>typeof v==='number'?v:d;

    const solar_w   = sf(dev?.solar_w   ?? plant.current_w);
    const batt_pct  = sf(dev?.battery_pct);
    const batt_w    = sf(dev?.battery_w);
    const grid_w    = sf(dev?.grid_w);
    const grid_dir  = dev?.grid_direction || 'export';
    const load_w    = sf(dev?.load_w);
    const today_kwh = sf(dev?.today_kwh  ?? plant.today_kwh);
    const total_kwh = sf(dev?.total_kwh  ?? plant.total_kwh);
    const exp_kwh   = sf(dev?.today_export_kwh);
    const imp_kwh   = sf(dev?.today_import_kwh);

    const fmt_w = w => Math.abs(w)>=1000 ? `${(Math.abs(w)/1000).toFixed(2)} kW` : `${Math.round(Math.abs(w))} W`;
    const upd   = data.updated
      ? new Date(data.updated).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})
      : 'â€“';

    el.innerHTML = `
      <div class="growatt-main">
        <div class="growatt-power">${fmt_w(solar_w)}</div>
        <div class="growatt-power-label">aktuÃ¡lnÃ­ vÃ½kon</div>
      </div>
      <div class="growatt-grid">
        <div class="growatt-cell">
          <div class="growatt-cell-label">Baterie</div>
          <div class="growatt-cell-val">${batt_pct.toFixed(0)} %</div>
          <div class="battery-bar-wrap"><div class="battery-bar-fill" style="width:${Math.min(100,batt_pct)}%"></div></div>
          <div class="growatt-cell-sub">${batt_w>0?'+':''}${Math.round(batt_w)} W</div>
        </div>
        <div class="growatt-cell">
          <div class="growatt-cell-label">SÃ­Å¥ <span class="direction-badge">${grid_dir==='export'?'â†‘ export':'â†“ import'}</span></div>
          <div class="growatt-cell-val">${fmt_w(grid_w)}</div>
          <div class="growatt-cell-sub">â†‘ ${exp_kwh.toFixed(1)} / â†“ ${imp_kwh.toFixed(1)} kWh dnes</div>
        </div>
        <div class="growatt-cell">
          <div class="growatt-cell-label">SpotÅ™eba</div>
          <div class="growatt-cell-val">${fmt_w(load_w)}</div>
        </div>
        <div class="growatt-cell">
          <div class="growatt-cell-label">VÃ½roba dnes</div>
          <div class="growatt-cell-val">${today_kwh.toFixed(2)} kWh</div>
          <div class="growatt-cell-sub">celkem ${total_kwh.toFixed(0)} kWh</div>
        </div>
      </div>
      <div class="growatt-updated">data z ${upd}</div>`;

  } catch(e) {
    el.innerHTML='<div class="growatt-notice">data/growatt.json nenalezen â€“ nastav GitHub Actions a pÅ™idej secrets.</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE KALENDÃÅ˜ (ICS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseICS(text) {
  const events=[];
  for (const block of text.split('BEGIN:VEVENT').slice(1)) {
    const get=k=>{const m=block.match(new RegExp(k+'[^:]*:([^\\r\\n]+)'));return m?m[1].trim():'';};
    const summary=get('SUMMARY'), dtstart=get('DTSTART');
    if (!summary||!dtstart) continue;
    const [y,mo,d]=[dtstart.slice(0,4),dtstart.slice(4,6),dtstart.slice(6,8)];
    const allDay=!dtstart.includes('T');
    const date=allDay?new Date(`${y}-${mo}-${d}T00:00:00`):new Date(`${y}-${mo}-${d}T${dtstart.slice(9,11)}:${dtstart.slice(11,13)}:00`);
    events.push({summary,date,allDay});
  }
  return events;
}

async function fetchCalendar() {
  const el=document.getElementById('event-list');
  const meta=document.getElementById('cal-meta');
  const notice=document.getElementById('ics-notice');
  if (!ICS_URL) { notice.textContent='Nastav ICS_URL pro Google KalendÃ¡Å™.'; return; }
  try {
    const text=await (await fetch(ICS_URL)).text();
    const now=new Date(), in14=new Date(now.getTime()+14*86400000);
    const ev=parseICS(text).filter(e=>e.date>=now&&e.date<=in14).sort((a,b)=>a.date-b.date).slice(0,8);
    if (!ev.length) { meta.textContent='Å½Ã¡dnÃ© udÃ¡losti v pÅ™Ã­Å¡tÃ­ch 14 dnech.'; return; }
    meta.textContent=`PÅ™Ã­Å¡tÃ­ch ${ev.length} udÃ¡lostÃ­:`;
    const dayN=['Ne','Po','Ãšt','St','ÄŒt','PÃ¡','So'];
    el.innerHTML=ev.map(e=>{
      const p=n=>String(n).padStart(2,'0');
      const t=e.allDay?`${dayN[e.date.getDay()]} ${e.date.getDate()}.${e.date.getMonth()+1}.`:`${dayN[e.date.getDay()]} ${e.date.getDate()}.${e.date.getMonth()+1}. ${p(e.date.getHours())}:${p(e.date.getMinutes())}`;
      return `<div class="event-item"><div class="event-dot"></div><div class="event-time">${t}</div><div class="event-title">${e.summary}</div></div>`;
    }).join('');
  } catch(e) { notice.textContent='Chyba naÄÃ­tÃ¡nÃ­ kalendÃ¡Å™e.'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ÃšKOLY (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTasks() {
  const tasks=JSON.parse(localStorage.getItem('dashboard_tasks')||'[]');
  const el=document.getElementById('task-list');
  if (!tasks.length) { el.innerHTML='<div class="empty-note">Å¾Ã¡dnÃ© Ãºkoly</div>'; return; }
  el.innerHTML=tasks.map(t=>`<div class="task-item ${t.done?'done':''}"><div class="task-check"></div><div class="task-text">${t.text}</div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initAll() {
  document.getElementById('last-update').textContent='aktualizujiâ€¦';
  await handleNetatmoCallback();
  await Promise.all([fetchWeather(), fetchNetatmo(), fetchGrowatt(), fetchCalendar()]);
  renderTasks();
  const now=new Date();
  document.getElementById('last-update').textContent=
    `â†º ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}

initAll();
setInterval(initAll, 15*60*1000);
</script>
</body>
</html>
