# CLAUDE.md — home_dashboard

Personal home dashboard for Vranov u Brna (Czech Republic). Static single-page
app hosted on GitHub Pages, with data collected by Python scripts running via
GitHub Actions.

---

## Repository layout

```
home_dashboard/
├── index.html                      # Entire frontend: HTML + CSS + JS in one file
├── scripts/
│   ├── fetch_growatt.py            # Solar system data from Growatt API
│   ├── fetch_tuya.py               # Gate status from Tuya IoT Cloud
│   └── fetch_school_menu.py        # School lunch menu scraper
├── data/
│   ├── growatt.json                # Generated by fetch_growatt.py
│   ├── tuya.json                   # Generated by fetch_tuya.py
│   └── school_menu.json            # Generated by fetch_school_menu.py
└── .github/workflows/
    ├── growatt.yml                 # Triggers fetch_growatt.py (manual, self-hosted runner)
    ├── tuya.yml                    # Triggers fetch_tuya.py (manual)
    └── school_menu.yml             # Triggers fetch_school_menu.py (weekdays 05:00 UTC)
```

---

## Technology stack

| Layer | Technology |
|-------|-----------|
| Frontend | Vanilla HTML5 / CSS3 / JavaScript (ES6+) — no framework, no build step |
| Backend scripts | Python 3.11 |
| Python deps | `growattServer`, `requests`, `beautifulsoup4` |
| Hosting | GitHub Pages (static) |
| Automation | GitHub Actions |
| Data transport | JSON files committed to the repo, served as static assets |

There is **no package manager, no bundler, no transpiler**. Edit files directly
and push — GitHub Pages redeploys automatically.

---

## Dashboard sections (index.html)

The page renders these sections in order, each populated by a dedicated async
function called inside `initAll()`:

| Section | JS function | Data source |
|---------|-------------|-------------|
| Clock / date | `updateClock()` | `Date` API, runs every second |
| Weather | `fetchWeather()` | Open-Meteo public API |
| Netatmo weather station | `fetchNetatmo()` | Netatmo API (OAuth2) via browser |
| Gate status | `fetchTuya()` | `data/tuya.json` |
| Solar system | `fetchGrowatt()` | `data/growatt.json` |
| Calendar | `fetchCalendar()` | Google Calendar iCal URL |
| School menu | `fetchSchoolMenu()` | `data/school_menu.json` |
| Tasks | `renderTasks()` | `localStorage` (`dashboard_tasks`) |

`initAll()` is called on page load and then every 15 minutes via `setInterval`.

---

## Configuration (constants at top of `<script>` in index.html)

```js
// Netatmo (OAuth2 Authorization Code flow — tokens stored in localStorage)
const NETATMO_CLIENT_ID     = '...';
const NETATMO_CLIENT_SECRET = '...';
const NETATMO_ACCESS_TOKEN  = '';   // optional static token (~3 h lifetime)

// Static JSON URLs (relative paths work on GitHub Pages)
const GROWATT_JSON_URL = './data/growatt.json';
const TUYA_JSON_URL    = './data/tuya.json';

// Google Calendar iCal feed (wrap in a CORS proxy if needed)
const ICS_URL = '';

// Geographic coordinates for Open-Meteo
const LAT = 49.043, LON = 16.558;  // Vranov u Brna
```

External credentials (API keys, passwords) are **never** stored in the
repository. They live in **GitHub Secrets** and are injected only during GitHub
Actions runs.

| Secret | Used by |
|--------|---------|
| `GROWATT_USER` | `fetch_growatt.py` |
| `GROWATT_PASS` | `fetch_growatt.py` |
| `TUYA_ACCESS_ID` | `fetch_tuya.py` |
| `TUYA_ACCESS_SECRET` | `fetch_tuya.py` |
| `TUYA_DEVICE_ID` | `fetch_tuya.py` |
| `TUYA_REGION` | `fetch_tuya.py` |

---

## Data flow

```
GitHub Actions (scheduled / manual)
  └─► scripts/fetch_*.py
        └─► external API
        └─► writes data/*.json
        └─► commits & pushes to main

GitHub Pages serves index.html + data/*.json
  └─► browser fetches data/*.json directly (cache-busted with ?t=Date.now())
  └─► browser calls Netatmo / Open-Meteo APIs directly
```

No server-side rendering; no API gateway. All dynamic data either comes from
the pre-built JSON files or is fetched client-side.

---

## GitHub Actions workflows

| Workflow | Schedule | Runner | Key secrets |
|----------|----------|--------|-------------|
| `school_menu.yml` | `0 5 * * 1-5` (05:00 UTC weekdays) + manual | `ubuntu-latest` | — |
| `growatt.yml` | Manual only | `self-hosted` | `GROWATT_USER`, `GROWATT_PASS` |
| `tuya.yml` | Manual only | `ubuntu-latest` | `TUYA_*` |

All workflows follow the same pattern:
1. Checkout repo
2. Set up Python 3.11
3. `pip install <deps>`
4. Run script (injects secrets via `env:`)
5. `git add data/<file>.json && git commit ... [skip ci] && git push`

The `[skip ci]` tag prevents infinite workflow loops.

---

## Python script conventions

- Read credentials from environment variables; exit with code 1 if missing.
- Use `safe_float(val, default=0.0)` helper for untrusted numeric values.
- Always write a JSON file with the shape `{"updated": "<ISO UTC>", "error": null|"string", ...}`.
- Output path is always `Path(__file__).parent.parent / "data" / "<name>.json"`.
- Scripts are standalone — run locally by setting the required env vars.

Local test run example:
```bash
GROWATT_USER=me GROWATT_PASS=secret python scripts/fetch_growatt.py
```

---

## CSS design system (in index.html `<style>`)

| Variable | Value | Usage |
|----------|-------|-------|
| `--ink` | `#0a0a0a` | Primary text |
| `--ink-mid` | `#3a3a3a` | Secondary text |
| `--ink-light` | `#888` | Labels, metadata |
| `--ink-faint` | `#ccc` | Timestamps, dividers |
| `--paper` | `#f5f2ec` | Background |
| `--paper-dark` | `#e8e4db` | Subtle backgrounds |
| `--rule` | `#d0ccc3` | Borders, dividers |

Typography:
- **Body / headings**: `Spectral` (Google Fonts, serif)
- **Data / labels / monospace**: `JetBrains Mono` (Google Fonts)

Layout: mobile-first, single column, `max-width: 480px`, centered.

Section labels use `.section-label` (JetBrains Mono, 0.6 rem, uppercase,
letter-spacing 0.18 em, `--ink-light` colour).

---

## Language and localisation

- **All UI text is in Czech** (`lang="cs"` on `<html>`).
- Day and month names are hardcoded Czech arrays in `updateClock()`.
- Python scripts, comments, error messages, and commit messages are also in Czech.
- Date/time is formatted with Czech locale (`cs-CZ`) using `toLocaleTimeString`.

---

## Adding a new data source

1. **Script**: create `scripts/fetch_<name>.py` — follows the existing pattern
   (env-var credentials, `safe_float`, write `data/<name>.json`).
2. **Workflow**: create `.github/workflows/<name>.yml` — copy an existing one,
   adjust deps, secrets, schedule, and add `[skip ci]` to the commit message.
3. **HTML section**: add a `<section>` in `index.html` with a `section-label`
   and a content div (e.g. `id="<name>-content"`).
4. **CSS**: add component-specific styles under the relevant comment block.
5. **JS fetch function**: add `async function fetch<Name>() { ... }` following
   the pattern of `fetchTuya()` or `fetchSchoolMenu()`.
6. **Wire up**: add `fetch<Name>()` to the `Promise.all(...)` inside `initAll()`.

---

## JSON data schemas

### `data/growatt.json`
```json
{
  "updated": "2025-02-21T10:00:00+00:00",
  "error": null,
  "plants": [
    {
      "id": "...",
      "name": "...",
      "today_kwh": 5.2,
      "total_kwh": 1234.5,
      "current_w": 800,
      "devices": [
        {
          "sn": "...", "name": "...", "type": "mix", "status": 1,
          "solar_w": 800, "battery_pct": 75, "battery_w": 200,
          "grid_w": 100, "grid_direction": "export",
          "load_w": 500, "today_kwh": 5.2, "total_kwh": 1234.5,
          "today_export_kwh": 1.1, "today_import_kwh": 0.0
        }
      ]
    }
  ]
}
```

### `data/tuya.json`
```json
{
  "updated": "2025-02-21T10:05:00+00:00",
  "error": null,
  "device_name": "Brána",
  "online": true,
  "gate_open": false,
  "dp_used": "1",
  "raw_dps": [{"code": "1", "value": false}]
}
```

### `data/school_menu.json`
```json
{
  "updated": "2025-02-21T05:01:00+00:00",
  "error": null,
  "week": "24.2.-28.2.2025",
  "days": {
    "pondeli": {"name": "Pondělí", "meals": ["Polévka: ...", "Oběd 1: ..."]},
    "utery":   {"name": "Úterý",   "meals": [...]},
    "streda":  {"name": "Středa",  "meals": [...]},
    "ctvrtek": {"name": "Čtvrtek", "meals": [...]},
    "patek":   {"name": "Pátek",   "meals": [...]}
  }
}
```

All JSON files share the envelope: `updated` (ISO 8601 UTC string) and `error`
(null or error description string).

---

## Commit message conventions

Follows Conventional Commits in Czech:

```
feat: přidat novou sekci XYZ
fix: opravit chybu v načítání dat Growatt
chore: update school menu [skip ci]   ← bot commits
```

---

## No tests

There is no automated test suite. Validate changes by:
- Running Python scripts locally with the appropriate env vars set.
- Opening `index.html` directly in a browser (some fetch calls need a server
  for relative paths — use `python -m http.server` or VS Code Live Server).
- Checking GitHub Actions run logs for script errors.
