# CLAUDE.md — home_dashboard

Personal home dashboard for Vranov u Brna (Czech Republic). Static single-page
app hosted on GitHub Pages, with data collected by Python scripts running via
GitHub Actions.

---

## Repository layout

```
home_dashboard/
├── index.html                      # Entire frontend: HTML + CSS + JS in one file
├── scripts/
│   ├── fetch_growatt.py            # Solar system data from Growatt API
│   ├── fetch_tuya.py               # Tuya sensor status (gate, garage) from Tuya IoT Cloud
│   ├── fetch_school_menu.py        # School lunch menu scraper
│   └── fetch_calendar.py           # Google Calendar events via iCal
├── data/
│   ├── growatt.json                # Generated by fetch_growatt.py
│   ├── tuya.json                   # Generated by fetch_tuya.py
│   ├── school_menu.json            # Generated by fetch_school_menu.py
│   └── calendar.json               # Generated by fetch_calendar.py
├── Odkazy.md                        # Useful links (Tuya, etc.)
└── .github/workflows/
    ├── growatt.yml                 # Triggers fetch_growatt.py (manual)
    ├── tuya.yml                    # Triggers fetch_tuya.py (every 30 min + manual)
    ├── school_menu.yml             # Triggers fetch_school_menu.py (weekdays 05:00 UTC)
    └── calendar.yml                # Triggers fetch_calendar.py (every hour + manual)
```

---

## Technology stack

| Layer | Technology |
|-------|-----------|
| Frontend | Vanilla HTML5 / CSS3 / JavaScript (ES6+) — no framework, no build step |
| Backend scripts | Python 3.11 |
| Python deps | `growattServer`, `requests`, `beautifulsoup4`, `icalendar`, `recurring-ical-events` |
| Hosting | GitHub Pages (static) |
| Automation | GitHub Actions |
| Data transport | JSON files committed to the repo, served as static assets |

There is **no package manager, no bundler, no transpiler**. Edit files directly
and push — GitHub Pages redeploys automatically.

---

## Dashboard sections (index.html)

The page renders these sections in order, each populated by a dedicated async
function called inside `initAll()`:

| Section | JS function | Data source |
|---------|-------------|-------------|
| Clock / date | `updateClock()` | `Date` API, runs every second |
| Weather (Počasí) | `fetchWeather()` | Open-Meteo public API |
| Netatmo weather station | `fetchNetatmo()` | Netatmo API (OAuth2) via browser |
| Tuya sensors (gate, garage) | `fetchTuya()` | `data/tuya.json` |
| Solar system (Growatt) | `fetchGrowatt()` | `data/growatt.json` |
| Calendar (Kalendář) | `fetchCalendar()` | `data/calendar.json` |
| Microsoft To Do | `fetchMsTodo()` | Microsoft Graph API (OAuth2 + PKCE) via browser |
| School menu (Jídelníček MŠ) | `fetchSchoolMenu()` | `data/school_menu.json` |
| Tasks (Úkoly) | `renderTasks()` | `localStorage` (`dashboard_tasks`) |

`initAll()` first runs `handleNetatmoCallback()` and `handleMsTodoCallback()`
(to handle OAuth2 redirects), then calls all fetch functions via `Promise.all`,
and finally `renderTasks()`. It is called on page load and then every
15 minutes via `setInterval`.

---

## Configuration (constants at top of `<script>` in index.html)

```js
// Netatmo (OAuth2 Authorization Code flow — tokens stored in localStorage)
const NETATMO_CLIENT_ID     = '...';  // hardcoded (public client-side OAuth app)
const NETATMO_CLIENT_SECRET = '...';  // hardcoded (public client-side OAuth app)
const NETATMO_ACCESS_TOKEN  = '';     // optional static token (~3 h lifetime)

// Static JSON URLs (relative paths work on GitHub Pages)
const GROWATT_JSON_URL   = './data/growatt.json';
const TUYA_JSON_URL      = './data/tuya.json';
const CALENDAR_JSON_URL  = './data/calendar.json';
const SCHOOL_MENU_URL    = './data/school_menu.json';

// Microsoft To Do (OAuth2 Authorization Code + PKCE — no client_secret needed)
// Register app at https://portal.azure.com → App registrations
// Redirect URI type must be "Single-page application (SPA)"
const MSTODO_CLIENT_ID = '...';      // Client ID from Azure portal (hardcoded)
const MSTODO_TENANT    = 'consumers'; // 'consumers' = personal MS accounts only

// Geographic coordinates for Open-Meteo
const LAT = 49.043, LON = 16.558;  // Vranov u Brna
```

Client-side OAuth credentials (`NETATMO_CLIENT_ID`, `NETATMO_CLIENT_SECRET`,
`MSTODO_CLIENT_ID`) are hardcoded in `index.html` — these are public client
IDs needed for browser-based OAuth flows.

Server-side credentials (API keys, passwords) live in **GitHub Secrets** and
are injected only during GitHub Actions runs.

| Secret | Used by |
|--------|---------|
| `GROWATT_USER` | `fetch_growatt.py` |
| `GROWATT_PASS` | `fetch_growatt.py` |
| `TUYA_ACCESS_ID` | `fetch_tuya.py` |
| `TUYA_ACCESS_SECRET` | `fetch_tuya.py` |
| `TUYA_DEVICE_ID` | `fetch_tuya.py` |
| `TUYA_DEVICE_ID_2` | `fetch_tuya.py` (optional second device) |
| `TUYA_REGION` | `fetch_tuya.py` |
| `CALENDAR_ICS_URL` | `fetch_calendar.py` |

---

## Data flow

```
GitHub Actions (scheduled / manual)
  └─► scripts/fetch_*.py (growatt, tuya, school_menu, calendar)
        └─► external API (Growatt, Tuya IoT, school website, Google Calendar iCal)
        └─► writes data/*.json
        └─► commits & pushes to main

GitHub Pages serves index.html + data/*.json
  └─► browser fetches data/*.json directly (cache-busted with ?t=Date.now())
  └─► browser calls Netatmo / Open-Meteo / Microsoft Graph APIs directly
```

No server-side rendering; no API gateway. All dynamic data either comes from
the pre-built JSON files or is fetched client-side.

---

## GitHub Actions workflows

| Workflow | Schedule | Runner | Key secrets |
|----------|----------|--------|-------------|
| `school_menu.yml` | `0 5 * * 1-5` (05:00 UTC weekdays) + manual | `ubuntu-latest` | — |
| `growatt.yml` | Manual only | `ubuntu-latest` | `GROWATT_USER`, `GROWATT_PASS` |
| `tuya.yml` | `*/30 * * * *` (every 30 min) + manual | `ubuntu-latest` | `TUYA_*`, `TUYA_DEVICE_ID_2` |
| `calendar.yml` | `0 * * * *` (every hour) + manual | `ubuntu-latest` | `CALENDAR_ICS_URL` |

All workflows follow the same pattern:
1. Checkout repo
2. Set up Python 3.11
3. `pip install <deps>`
4. Run script (injects secrets via `env:`)
5. `git add data/<file>.json && git commit ... [skip ci] && git push`

The `[skip ci]` tag prevents infinite workflow loops.

---

## Python script conventions

- Read credentials from environment variables; exit with code 1 if missing.
- Use `safe_float(val, default=0.0)` helper for untrusted numeric values.
- Always write a JSON file with the shape `{"updated": "<ISO UTC>", "error": null|"string", ...}`.
- Output path is always `Path(__file__).parent.parent / "data" / "<name>.json"`.
- Scripts are standalone — run locally by setting the required env vars.

Local test run example:
```bash
GROWATT_USER=me GROWATT_PASS=secret python scripts/fetch_growatt.py
```

---

## CSS design system (in index.html `<style>`)

| Variable | Value | Usage |
|----------|-------|-------|
| `--ink` | `#0a0a0a` | Primary text |
| `--ink-mid` | `#3a3a3a` | Secondary text |
| `--ink-light` | `#888` | Labels, metadata |
| `--ink-faint` | `#ccc` | Timestamps, dividers |
| `--paper` | `#f5f2ec` | Background |
| `--paper-dark` | `#e8e4db` | Subtle backgrounds |
| `--rule` | `#d0ccc3` | Borders, dividers |

Typography:
- **Body / headings**: `Spectral` (Google Fonts, serif)
- **Data / labels / monospace**: `JetBrains Mono` (Google Fonts)

Layout: mobile-first, single column, `max-width: 480px`, centered.

Section labels use `.section-label` (JetBrains Mono, 0.6 rem, uppercase,
letter-spacing 0.18 em, `--ink-light` colour).

---

## Language and localisation

- **All UI text is in Czech** (`lang="cs"` on `<html>`).
- Day and month names are hardcoded Czech arrays in `updateClock()`.
- Python scripts, comments, error messages, and commit messages are also in Czech.
- Date/time is formatted with Czech locale (`cs-CZ`) using `toLocaleTimeString`.

---

## Adding a new data source

1. **Script**: create `scripts/fetch_<name>.py` — follows the existing pattern
   (env-var credentials, `safe_float`, write `data/<name>.json`).
2. **Workflow**: create `.github/workflows/<name>.yml` — copy an existing one,
   adjust deps, secrets, schedule, and add `[skip ci]` to the commit message.
3. **HTML section**: add a `<section>` in `index.html` with a `section-label`
   and a content div (e.g. `id="<name>-content"`).
4. **CSS**: add component-specific styles under the relevant comment block.
5. **JS fetch function**: add `async function fetch<Name>() { ... }` following
   the pattern of `fetchTuya()` or `fetchSchoolMenu()`.
6. **Wire up**: add `fetch<Name>()` to the `Promise.all(...)` inside `initAll()`.

---

## JSON data schemas

### `data/growatt.json`
```json
{
  "updated": "2025-02-21T10:00:00+00:00",
  "error": null,
  "plants": [
    {
      "id": "...",
      "name": "...",
      "today_kwh": 5.2,
      "total_kwh": 1234.5,
      "current_w": 800,
      "devices": [
        {
          "sn": "...", "name": "...", "type": "mix", "status": 1,
          "solar_w": 800, "battery_pct": 75, "battery_w": 200,
          "grid_w": 100, "grid_direction": "export",
          "load_w": 500, "today_kwh": 5.2, "total_kwh": 1234.5,
          "today_export_kwh": 1.1, "today_import_kwh": 0.0
        }
      ]
    }
  ]
}
```

### `data/tuya.json`
```json
{
  "updated": "2025-02-21T10:05:00+00:00",
  "error": null,
  "devices": [
    {
      "device_name": "Garáž",
      "online": true,
      "gate_open": false,
      "dp_used": "switch",
      "raw_dps": [{"code": "switch", "value": false}]
    },
    {
      "device_name": "Brána",
      "online": true,
      "gate_open": false,
      "dp_used": "doorcontact_state",
      "raw_dps": [{"code": "doorcontact_state", "value": false}]
    }
  ]
}
```

### `data/school_menu.json`
```json
{
  "updated": "2025-02-21T05:01:00+00:00",
  "error": null,
  "week": "24.2.-28.2.2025",
  "days": {
    "pondeli": {"name": "Pondělí", "meals": ["Polévka: ...", "Oběd 1: ..."]},
    "utery":   {"name": "Úterý",   "meals": [...]},
    "streda":  {"name": "Středa",  "meals": [...]},
    "ctvrtek": {"name": "Čtvrtek", "meals": [...]},
    "patek":   {"name": "Pátek",   "meals": [...]}
  }
}
```

### `data/calendar.json`
```json
{
  "updated": "2025-02-21T10:00:00+00:00",
  "error": null,
  "recurring": [
    {"summary": "Event name", "date": "2025-02-24", "all_day": false, "location": ""}
  ],
  "single": [
    {"summary": "Event name", "date": "2025-02-25", "all_day": true, "location": "Place"}
  ]
}
```

All JSON files share the envelope: `updated` (ISO 8601 UTC string) and `error`
(null or error description string).

---

## Commit message conventions

Follows Conventional Commits in Czech:

```
feat: přidat novou sekci XYZ
fix: opravit chybu v načítání dat Growatt
chore: update school menu [skip ci]   ← bot commits
```

---

## No tests

There is no automated test suite. Validate changes by:
- Running Python scripts locally with the appropriate env vars set.
- Opening `index.html` directly in a browser (some fetch calls need a server
  for relative paths — use `python -m http.server` or VS Code Live Server).
- Checking GitHub Actions run logs for script errors.
